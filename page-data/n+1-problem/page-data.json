{"componentChunkName":"component---src-templates-post-jsx","path":"/n+1-problem/","result":{"data":{"site":{"siteMetadata":{"title":"pointing the dots"}},"markdownRemark":{"id":"6df80ce2-79eb-584d-871c-9ec94a17114c","excerpt":"N+1 문제가 뭘까? 하나의 엔티티 전체를 조회하면서 그와 연관된 다른 엔티티를 조회할 때, 여러 번의 쿼리가 발생하는 문제입니다. 예를 들어, Team 엔티티와 Member 엔티티 사이에 다음과 같이 1:N(일대다)의 관계가 있다고 해보겠습니다. 그리고 각각의 엔티티는 다음과 같이 정의되어 있습니다. 총 3개의 팀이 있고, 각 팀에는 3명의 멤버가 있습…","html":"<h2>N+1 문제가 뭘까?</h2>\n<p>하나의 엔티티 전체를 조회하면서 그와 연관된 다른 엔티티를 조회할 때, 여러 번의 쿼리가 발생하는 문제입니다. 예를 들어, Team 엔티티와 Member 엔티티 사이에 다음과 같이 1:N(일대다)의 관계가 있다고 해보겠습니다.</p>\n<figure>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 641px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/d81dffb964b3632055d9d945fc8f8a25/243e6/n%2B1-01.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 15.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAlUlEQVR42jXISw6CMBQAQE5hSBpLse2jpf8fNBA1gY0LXXv/m0hMmOU0JZllzqwnt+5KMMKoHQWvJY1CjietVM6FUoox7v4IIdbaZpvg+94++/31nKsFQ5FjaDYyh2iN9sY4Y7N3q8d7dY+kZsMEvui+1Qw3ALJMdVQ6xORDpIxzGBiHw3CCAZTk61JTDFNOwKgUx/Ef3xIeh7Zuwq4AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='n 1 01' title='' src='/static/d81dffb964b3632055d9d945fc8f8a25/243e6/n%2B1-01.png' srcset='/static/d81dffb964b3632055d9d945fc8f8a25/e7570/n%2B1-01.png 170w,\n/static/d81dffb964b3632055d9d945fc8f8a25/f46e7/n%2B1-01.png 340w,\n/static/d81dffb964b3632055d9d945fc8f8a25/243e6/n%2B1-01.png 641w' sizes='(max-width: 641px) 100vw, 641px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n</figure>\n<p>그리고 각각의 엔티티는 다음과 같이 정의되어 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@NoArgsConstructor</span>\n<span class=\"token annotation punctuation\">@Builder</span>\n<span class=\"token annotation punctuation\">@AllArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"member_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@ManyToOne</span>\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"team_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Team</span> team<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">joinNewTeam</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Team</span> team<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>team <span class=\"token operator\">=</span> team<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@NoArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Team</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IDENTITY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"team_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@OneToMany</span><span class=\"token punctuation\">(</span>mappedBy <span class=\"token operator\">=</span> <span class=\"token string\">\"team\"</span><span class=\"token punctuation\">,</span> cascade <span class=\"token operator\">=</span> <span class=\"token class-name\">CascadeType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ALL</span><span class=\"token punctuation\">,</span> fetch <span class=\"token operator\">=</span> <span class=\"token class-name\">FetchType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">LAZY</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> memberList <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Builder</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Team</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> memberList<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> id<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>memberList <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>memberList <span class=\"token operator\">=</span> memberList<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">addNewMember</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Member</span> member<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>memberList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        member<span class=\"token punctuation\">.</span><span class=\"token function\">joinNewTeam</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>총 3개의 팀이 있고, 각 팀에는 3명의 멤버가 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@BeforeEach</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Team</span><span class=\"token punctuation\">></span></span> teamList <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Team</span> team <span class=\"token operator\">=</span> <span class=\"token class-name\">Team</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"팀 \"</span> <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span> j<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            team<span class=\"token punctuation\">.</span><span class=\"token function\">addNewMember</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"멤버 \"</span> <span class=\"token operator\">+</span> i <span class=\"token operator\">+</span> j<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        teamList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>team<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        teamRepository<span class=\"token punctuation\">.</span><span class=\"token function\">saveAll</span><span class=\"token punctuation\">(</span>teamList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TeamService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">TeamRepository</span> teamRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllMemberNameFromAllTeam</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n========== 모든 팀 조회 ==========\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Team</span><span class=\"token punctuation\">></span></span> teamList <span class=\"token operator\">=</span> teamRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token function\">findAllMemberName</span><span class=\"token punctuation\">(</span>teamList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllMemberName</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Team</span><span class=\"token punctuation\">></span></span> teamList<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n========== 각 팀의 멤버 조회 ==========\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> nameList <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Team</span> team <span class=\"token operator\">:</span> teamList<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            nameList<span class=\"token punctuation\">.</span><span class=\"token function\">addAll</span><span class=\"token punctuation\">(</span>team<span class=\"token punctuation\">.</span><span class=\"token function\">getMemberList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Member</span><span class=\"token operator\">::</span><span class=\"token function\">getName</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> nameList<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>우리는 모든 팀을 조회하고 각 팀에 속해 있는 모든 멤버들의 이름을 가져오고 싶습니다. 이것을 하나의 쿼리로 처리하고 싶지만 실제 실행된 쿼리를 보면 여러 쿼리가 동작한다는 것을 알 수 있는데, 이것이 N+1 문제입니다.</p>\n<figure>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 372px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/e9f4f31c8d7e8e42fd89a0e774ffb3b1/448ef/n%2B1-02.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 271.1764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='n 1 02' title='' src='/static/e9f4f31c8d7e8e42fd89a0e774ffb3b1/448ef/n%2B1-02.png' srcset='/static/e9f4f31c8d7e8e42fd89a0e774ffb3b1/e7570/n%2B1-02.png 170w,\n/static/e9f4f31c8d7e8e42fd89a0e774ffb3b1/f46e7/n%2B1-02.png 340w,\n/static/e9f4f31c8d7e8e42fd89a0e774ffb3b1/448ef/n%2B1-02.png 372w' sizes='(max-width: 372px) 100vw, 372px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n</figure>\n<p>처음에 모든 팀을 가져오는 쿼리가 실행되고(1), 총 N개의 팀을 가져오게 됩니다. 그리고 각 팀의 멤버들에 접근해야 하기 때문에 또 다시 각 팀에 대해서 쿼리가 실행됩니다.(N)</p>\n<p>우리의 예제에서는 총 3개의 팀이 있기 때문에, 모든 팀을 조회하는 쿼리 1개와 3개의 각 팀의 멤버들에 접근하는 쿼리 3개가 실행되는 것을 볼 수 있습니다.</p>\n<h2>무엇이 문제인데?</h2>\n<p>우리는 각 팀에 속해 있는 모든 멤버들의 이름을 가져오고 싶습니다. 하지만 기존의 방식대로 하면 팀들을 조회하는 쿼리와 각 팀의 멤버들을 조회하는 쿼리가 따로 나가기 때문에 문제가 됩니다. 위에서 든 예시에서는 팀의 수가 매우 적기 때문에 추가적으로 실행되는 쿼리의 수가 적지만, 만약 팀의 수가 매우 많은 경우에는 팀의 수만큼 쿼리가 실행되기 때문에 성능에 큰 문제가 될 수 있습니다.</p>\n<p>따라서, 쿼리가 따로 실행되는 것이 아니라 한 번의 쿼리로 팀의 정보와 각 팀들의 정보를 가져오는 방법이 없는지 고민해보아야 합니다.</p>\n<h2>왜 발생할까?</h2>\n<p>N+1 문제가 왜 발생할까요? 그럼 반대로 생각해보겠습니다. N+1 문제가 발생하지 않도록 하려면 JPA가 어떻게 동작해야 할까요?</p>\n<p>모든 팀의 조회하는 쿼리와 함께 각 팀에 연관된 엔티티도 모두 조회하는 쿼리도 포함시켜서 한 번에 처리하고 전부 영속성 컨텍스트에 저장해야 합니다. 하지만, JPA가 기본적으로 이렇게 동작한다면 이 역시도 큰 문제가 될 것입니다.</p>\n<h2>FetchType.LAZY(지연 로딩)을 하면 괜찮지 않을까?</h2>\n<p>JpaRepository의 메소드들은 JPQL로 실행되는데, JPQL은 Fetch 전략과 상관없이 일단 SQL로 변환되어 실행됩니다. 즉시 로딩, 지연 로딩 같은 글로벌 Fetch 전략과 상관없이 일단 모든 팀의 정보를 가져옵니다. 그 이후에 JPA는 엔티티에 설정된 Fetch 전략에 따라 연관된 엔티티를 바로 가져올지 말지 판단합니다.</p>\n<p>따라서, N+1 문제는 즉시 로딩이나 지연 로딩과 상관 없습니다. <code class=\"language-text\">FetchType.EAGER</code>인 경우에는 모든 팀을 조회하는 쿼리가 수행된 이후에 추가적인 쿼리도 바로 연이어 나가고, <code class=\"language-text\">FetchType.LAZY</code>인 경우에는 추가 쿼리가 바로 나가지는 않지만, 각 팀에 접근해서 멤버들을 조회할 때 쿼리가 나가게 됩니다.</p>\n<p>즉, 즉시 로딩이나 지연 로딩은 연관된 엔티티를 가져오는 쿼리가 언제 나가느냐에 차이가 있을 뿐, 결과적으로 둘 다 추가적인 쿼리를 통해서 연관된 엔티티를 가져옵니다.</p>\n<h2>그럼 어떻게 해결하지?</h2>\n<p>대표적인 해결 방법으로는 Fetch Join, @EntityGraph, BatchSize를 이용하는 방법이 있습니다.</p>\n<h2>Fetch Join</h2>\n<ul>\n<li>코드 블럭으로 보기\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select t from Team t join fetch t.memberList\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Team</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllFetchJoin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span>\n    team0_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id1_1_0_<span class=\"token punctuation\">,</span>\n    memberlist1_<span class=\"token punctuation\">.</span>member_id <span class=\"token keyword\">as</span> member_i1_0_1_<span class=\"token punctuation\">,</span>\n    team0_<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name2_1_0_<span class=\"token punctuation\">,</span>\n    memberlist1_<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name2_0_1_<span class=\"token punctuation\">,</span>\n    memberlist1_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_0_1_<span class=\"token punctuation\">,</span>\n    memberlist1_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_0_0__<span class=\"token punctuation\">,</span>\n    memberlist1_<span class=\"token punctuation\">.</span>member_id <span class=\"token keyword\">as</span> member_i1_0_0__\n<span class=\"token keyword\">from</span>\n    team team0_\n<span class=\"token keyword\">inner</span> <span class=\"token keyword\">join</span>\n    member memberlist1_\n        <span class=\"token keyword\">on</span> team0_<span class=\"token punctuation\">.</span>team_id<span class=\"token operator\">=</span>memberlist1_<span class=\"token punctuation\">.</span>team_id</code></pre></div>\n</li>\n</ul>\n<p>Fetch Join은 일반 SQL에서 제공하는 기능이 아닌, JPQL에서 성능 최적화를 위해 제공하는 기능입니다. Fetch Join을 사용하면 연관된 엔티티나 컬렉션을 한 번의 SQL 쿼리로 가져올 수 있습니다.</p>\n<figure>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 565px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/dafd0b54d870121edf7e30ab7d61a9bc/a1277/n%2B1-03.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 10%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAd0lEQVR42g3C3Q6CIBgAUJ8mim4aPwIiH4ikE3ARTTcv8v0fo85O44e9dZnbCPbD+vmhRwNVwZAyUHDSrKJPGl4aCgObjm8+TperLxUr2+i4hDjNaaT+LZeT+MrDzsImp40+C24BEXWl3T+i6i4MFv2Na0S7C5E/ZAcdww8wbZ0AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='n 1 03' title='' src='/static/dafd0b54d870121edf7e30ab7d61a9bc/a1277/n%2B1-03.png' srcset='/static/dafd0b54d870121edf7e30ab7d61a9bc/e7570/n%2B1-03.png 170w,\n/static/dafd0b54d870121edf7e30ab7d61a9bc/f46e7/n%2B1-03.png 340w,\n/static/dafd0b54d870121edf7e30ab7d61a9bc/a1277/n%2B1-03.png 565w' sizes='(max-width: 565px) 100vw, 565px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n</figure>\n<figure>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 378px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/c30a524c6ff0a5ecc8fac89d9579221b/1b718/n%2B1-04.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 88.82352941176471%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsTAAALEwEAmpwYAAACHUlEQVR42o2UiXLaQBBE+ZJUOQbiIxy671taHQgBxthxJZX//4w8aYlCSKrsqjHssjs90z29noTNExHUBzvbfNGcuWp/PCYkLN042hyttJkr1nRtXsbtypAht9fJM8W60921nxtJZWXNoxWs/WzlpSsvAZSFEuRqWCycfk0l7hPnZPn1eamTXB5/6HEZt89euTPTxhVbV3Q0xdZIaj6BoNK94c9V508yYFa2iTbPZlKTQHE73yTbkxYK4LSodIpt2r3wCSgotPNXMjey3Td648wpWo5lWTWkbTEd5LjmLL84ABJsaIf1QY+F7JMtEbcnoBU/nw+c56p1nWznbda9AsHYUIi2/WoPhB5XYXPklFnSzqMVQvvfZEi+9AUFlArIB9UBLC0SBGsn3wIHytpLL5I1ONvcQ2c098qOCujkFp2Z1mpQGHElBXfyFl3RRU7rXPlmoaGkePoOMAwl4WL/xm3EI4Ga+f4NCWk+GESBeW+SB9OnztkMdrR0E6yCSaQ3ZAxbgW2+DhcWTiQdZjN06nAg3XZveLNhMKMrR6tebn+3rVifHlbQox8GU59+gk3+u++kbxv1s90rbSM487xZqCP8aOP/J/NHBUhKMzAkBksXeoQrBbi3K326HhpW+pCMZsNinLOBPH51IAeHj4LzIxTkO0MqAlFYUwyZJ2MPPKw73UPS3luD9V2xc4sta15I/98ib3ln/I7hmJkWiV/C9vCo9Qh+qAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='n 1 04' title='' src='/static/c30a524c6ff0a5ecc8fac89d9579221b/1b718/n%2B1-04.png' srcset='/static/c30a524c6ff0a5ecc8fac89d9579221b/e7570/n%2B1-04.png 170w,\n/static/c30a524c6ff0a5ecc8fac89d9579221b/f46e7/n%2B1-04.png 340w,\n/static/c30a524c6ff0a5ecc8fac89d9579221b/1b718/n%2B1-04.png 378w' sizes='(max-width: 378px) 100vw, 378px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n</figure>\n<p>그리고 위 사진에서 볼 수 있다시피 Fetch Join은 Inner Join으로 수행됩니다.</p>\n<h2>@EntityGraph</h2>\n<ul>\n<li>코드 블럭으로 보기\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@EntityGraph</span><span class=\"token punctuation\">(</span>attributePaths <span class=\"token operator\">=</span> <span class=\"token string\">\"memberList\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select t from Team t\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Team</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllEntityGraph</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span>\n    team0_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id1_1_0_<span class=\"token punctuation\">,</span>\n    memberlist1_<span class=\"token punctuation\">.</span>member_id <span class=\"token keyword\">as</span> member_i1_0_1_<span class=\"token punctuation\">,</span>\n    team0_<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name2_1_0_<span class=\"token punctuation\">,</span>\n    memberlist1_<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">as</span> name2_0_1_<span class=\"token punctuation\">,</span>\n    memberlist1_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_0_1_<span class=\"token punctuation\">,</span>\n    memberlist1_<span class=\"token punctuation\">.</span>team_id <span class=\"token keyword\">as</span> team_id3_0_0__<span class=\"token punctuation\">,</span>\n    memberlist1_<span class=\"token punctuation\">.</span>member_id <span class=\"token keyword\">as</span> member_i1_0_0__\n<span class=\"token keyword\">from</span>\n    team team0_\n<span class=\"token keyword\">left</span> <span class=\"token keyword\">outer</span> <span class=\"token keyword\">join</span>\n    member memberlist1_\n        <span class=\"token keyword\">on</span> team0_<span class=\"token punctuation\">.</span>team_id<span class=\"token operator\">=</span>memberlist1_<span class=\"token punctuation\">.</span>team_id</code></pre></div>\n</li>\n</ul>\n<p>@EntityGraph의 <code class=\"language-text\">attributePaths</code>에 쿼리 수행 시에 같이 가져올 필드명을 지정하면 한 번에 모두 가져오게 됩니다.</p>\n<figure>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 451px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/3ffae394457da71dfbc43b2e91c17d9d/99c16/n%2B1-05.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 18.823529411764707%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAyElEQVR42k3GwVLCMBAA0H6Mg3qgpaUQGrKbZLNJS9ICQqmKHS/+/z+oMx6ceYeXoblIPBK9GjuSn41vGcChPlg8WJOIHGAhbaEpTF2cE11bEUifeM0hM/bWwEmGs6aLc+8K4xaMVN6ZATXFDtlh40OOlO9VqbFQsJTq50+bfUZhNP5FUADbI03SjjmECnp09xojR+YYak5L4IdC/Fr9WVQia3rade14NmHgZ0jN8FX7t017L9214qnkj4pnkT5Lf3xcy0W1++8bQH47sViuZ3oAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='n 1 05' title='' src='/static/3ffae394457da71dfbc43b2e91c17d9d/99c16/n%2B1-05.png' srcset='/static/3ffae394457da71dfbc43b2e91c17d9d/e7570/n%2B1-05.png 170w,\n/static/3ffae394457da71dfbc43b2e91c17d9d/f46e7/n%2B1-05.png 340w,\n/static/3ffae394457da71dfbc43b2e91c17d9d/99c16/n%2B1-05.png 451w' sizes='(max-width: 451px) 100vw, 451px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n</figure>\n<figure>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 376px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/c8b43acd5fd15c9f19790f39a4b39942/1075d/n%2B1-06.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 89.41176470588235%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsTAAALEwEAmpwYAAACIUlEQVR42o2T6XLaQBCEeRL/sEG2sY3Qfd8nCCEuO06cvP9r5JOWEtiVVLlqatkV2zPT3bMTv+ri5uRVO6do7zVHUu3vx+RBdxduHG9Odr6RNHu6NKdLY1jPcSdfjl/BM8WioBLkZrqys+bR8NnLXrpwE4LN0s+IZzt8cWJuzhQbyBksfu5knRvF/pcWVcFq79c7kcvOm/5YdUay8spO4GlWEOzBQz7LytbJ5pXVLbdqUIBM2lcjqY241uMKUuXhA12svOECX0CdKwOm26x7pz73uKSGBZuoOaphrkWlpDqCoKh5qUwgBn0Wu59W1oTrgx7X1GTjFBszXWfdD3LJXiLKSOpnzjPFBBA1JzDYpieVmdTURwJg0Lb7blu6e7KCR8P7BB4qU+Edzl7VgSGLwECPCFcHqCIkvSz99BrsTJfWWLkXLCzgSWW4sBcfWckFL3SRBrfOlW8XOvJUxz8kTto3MCCR1y1avvAXbtWn373aaYNnZIQ8YAvfxCTwCSeZjWFNlaAQ0zIcY7gMY5Mofg753iom5kH3oMdZmEEuNl8Gczjq18dL2zdzWQ1LUjBJ5f6Dgteu/vdhcAnp4clUYSydow0d3i400o9j/G+wGJcnK0RewDSPPEhKFjg/29H4yEgkYtyPPhuAGUZhb7p9wxW/N7wkr3hhPCwmBEVenGhuBnPTn4w9oId4m5QV+tE/wczwQqL1EdvcYisGjmnR4+ovKaDxNO1CvU4AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='n 1 06' title='' src='/static/c8b43acd5fd15c9f19790f39a4b39942/1075d/n%2B1-06.png' srcset='/static/c8b43acd5fd15c9f19790f39a4b39942/e7570/n%2B1-06.png 170w,\n/static/c8b43acd5fd15c9f19790f39a4b39942/f46e7/n%2B1-06.png 340w,\n/static/c8b43acd5fd15c9f19790f39a4b39942/1075d/n%2B1-06.png 376w' sizes='(max-width: 376px) 100vw, 376px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n</figure>\n<p>주목할 점은 Fetch Join은 Inner Join으로 수행되는 반면, @EntityGraph는 Outer Join으로 수행된다는 것입니다.</p>\n<h2>Fetch Join과 @EntityGraph의 문제점</h2>\n<ol>\n<li>\n<p>단순 Fetch Join만을 사용하면 카테시안 곱이 발생하기 때문에 일대다 관계의 일(1) 부분에서 중복 발생하게 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">joinFetch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n========== Fetch Join 테스트 ==========\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n========== 모든 팀 조회 ==========\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Team</span><span class=\"token punctuation\">></span></span> allTeams <span class=\"token operator\">=</span> teamRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAllFetchJoin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n========== 모든 팀 조회 끝 ==========\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n========== 각 팀의 멤버 조회 ==========\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> allMemberNames <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Team</span> team <span class=\"token operator\">:</span> allTeams<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>team<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Member</span> member <span class=\"token operator\">:</span> team<span class=\"token punctuation\">.</span><span class=\"token function\">getMemberList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            allMemberNames<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n========== 각 팀의 멤버 조회 끝 ==========\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"allTeams = \"</span> <span class=\"token operator\">+</span> allTeams<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"allMemberNames = \"</span> <span class=\"token operator\">+</span> allMemberNames<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<figure>\n <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 291px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/8e9dd5b6110505f803562a2898a3b90f/b3b34/n%2B1-07.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 337.05882352941177%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAABDCAIAAAATYLIVAAAACXBIWXMAAAsTAAALEwEAmpwYAAADOUlEQVR42p2XiW7aQBCGeZPmam7A2JjLF74wxkAMhCMEpTnavP8j9LOpaFQ1kXakkRUcz+7MP/P/s1u5Mu1ONO7GE3s4c9J5KxiZ/jCebaP8YTDfDhe7fnY/mD82+4mTLnqDKZ9hN23ne6NdqXb7rSCt9fwLo3uudzDe7v8un11+Yvt//WOVuhXYw1yzgzOt9d8vvrCKZgXT7RuRB9P1Zzt86nzbcd10rtmR7sbKzgQ82by1gxFgKDsDVZw/GN6gE2XKzqAdlc5US9kZtHHT7PC4qiujzc5OOiNz4ld2Zufx5rUdZv54KQCsH8+KnPEX1NkLpiuKjL+gzuF0+xM+kLmkVFZyR+ZCwHDWrPDoVr1UAJYsdqafsoQE7XC6NrykJ+gw2gNKtgpiqDtXO543WoA5QiNhVbZ+oUMkpdJKYly37NO6KSEGOBP8ZbMnqTMdRqn8yUrS2152z/6sItgZwJ4bTowMnevqSoKz4caFDOnq0kuRCL7hhOqib4dMjJu2WxKjq9zbqGfDiegwCasYgjjLWOVnqx+abGcqTJ3BvOklkg7LH9/hszPMJRrGfKVUh+GuBlgnHl+3HAmrCmI8vIGWO1pIwkb0WYJzjGRKTjavTAzERFKqKN/Ue77uRhLAOHXRYZJjBcSwkin7H1cN9bA7HqchnAlBoiTj9QtQe9lCgLa/Z5VE9PdokzkTR1Lnu0J6h5KJASVKYrgMDZmGzWqyUhXSu3ouz+K5JOz+eCknBrOqOLiGooOrP1lSZy4LyuMG9aTDDHdgCTSMDoPJlEo43CEjpZIMd+qcP/4iYTIXAsYSHA4kzsl8B9rU+VxwGqLD9gKoPNyZzPQ2mDOrGBqHufHhRvj3+dEKZ/L8dqOd1Iyjqn6qmVwKsdN6EzupFbb/+ee9Zh6suIhemZbuDsiZDsUIgdtdeZdNSQS2NgqdSMmLRuaJ8TFPJlSF8h5eMSuBHeOygqRRBYxDB0c0pII9AJVFm/3iSV8VOdMkHIXCuw37cDHmC7IoYzYg+RlBHsKumwcrwkZAWIk9UW9YDUPR4AujByQsdNm0vgKs2vWYj+nyabx5YXRAknz37o7mJO+N0HPvi875DcWPLoT9gjumAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='n 1 07' title='' src='/static/8e9dd5b6110505f803562a2898a3b90f/b3b34/n%2B1-07.png' srcset='/static/8e9dd5b6110505f803562a2898a3b90f/e7570/n%2B1-07.png 170w,\n/static/8e9dd5b6110505f803562a2898a3b90f/b3b34/n%2B1-07.png 291w' sizes='(max-width: 291px) 100vw, 291px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n</figure>\n<figure>\n <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 313px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/6f428d42bd7bff13ec86c0454b7198af/8e749/n%2B1-08.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 197.64705882352942%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAoCAIAAABxU02MAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEHElEQVR42nVWZ5OjVhDU//9Lrjrfle3bcFolEAgQOQeRUQTkfiQldksfngRNT890DztZzfkffwk/fwh/3jlqyfIs/fav+Od9K/H0x388fpxNOZGnP39zH2/8fMrhhukH/8+vrSoxE3olzKbm/MtYU7ooGAK/+fX3+vNdUESWWijU0tgwhqHy1FJaLXDWFWn78cZOPzXblCbhzrxeL9f6XFXn67X2PHux+JBlzraM4zHDpbouizwtipjcdi33RbqmZ1kWnU/FJPDtsqwvl/JywbVrEPgURUuS7Dr2fr8vy6qu6ySOwjCsqrqqqqLIJFEsisMJ4F1gX0ogz+fzqa4r33OWq4WqKK5rF0WOK1VVJkkURTsc8DXLUkHg8jw/HrKJ75kNawcG5utrut0KlmXkedaCQbzb+S04z1A2hYedjvnENOTL5Qb2PGc+nymKsgv8PE9xd8uWJHF7xo8UtYrjmIAtU3kFa5oKqpYZH5Qdx2FZtmUnPLchZR+zialL92BoXq2Wqgpmr2VGtaTqwO81J9stXxQF0fwEBvNs9kXAOx/VduAoDIKbZmZNd2U/g11StixLrmNhKr3m5F4zTX+vebGYi6LoOPYATtMYsgcwx23SNB1hbkclilvHsYZRhah60JyShhX7VvPTqFwbmjHngXlEM0NH35W9XC50XTNNvW1YW3Yc38per6m+YYZ0Jn+n0+mIZ4MZmi3L0jQFOvFQfFrN7RnNY5k1wKRs21Jbx6OmPhiU4zimSeyJVOBH3Ipg4ICvMDw6sj8cz6c9adg9MxqGUQFp6FqaJqCC8aPGJWUTATBvNixG1zA/avYbzbaNwg2AB3sOqYJmlmUAJpp1TXwdFVqNA5o0ANKHYCyjOBoBew0YzMC34HZUKHvwNjcEwxgLBpCYWZzEuL8B7+7zjGWQZdk482w2dV0HZUNqy4xmD8xkGaz7ZaAqwmsw0G1dVzHeQefQvIdgaOp2FGwYWp+kshnzyw6D5ueym1FZljmAe833DWO7BShL3OuourLvwEHg3WmmO82urb2mSpJEgBvmbs6PC3DZaX4C+76LUWGT9OARh/F8Pyrs7T4X7RvDA1jXdRg0zxCMCnHAU7C6m1yQNwaCcTgeyOvGc43z5TGSZG/LOolkTIJRXhrN/hAMeLuL5OgCxN5uTAKHjSxAvDFgvhGT+P0mcZ1bMJ7Amw3TgbVnhxF7qmBuwGVjTzgkuFv6PL/plv6LPcmcVVUdItnPeQhGwmANJaP2bN5VKBsmexxVeP+W7Oasj4FhkjtvPwcDq/cWDOCewLIsm997G8HoNatCE/ju3wrPc2eEWcYGBB3cA2dAPNDEIlWFlcowTJpmxCSWIaZJmOcRnoTvgW9tWErXJKzkOPJRGz5x5IWB056zZCduWVw6FOH/1ai+yJ77ScoAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='n 1 08' title='' src='/static/6f428d42bd7bff13ec86c0454b7198af/8e749/n%2B1-08.png' srcset='/static/6f428d42bd7bff13ec86c0454b7198af/e7570/n%2B1-08.png 170w,\n/static/6f428d42bd7bff13ec86c0454b7198af/8e749/n%2B1-08.png 313w' sizes='(max-width: 313px) 100vw, 313px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n</figure>\n<p>이를 해결하기 위해서는 JPQL의 DISTINCT 키워드를 사용하거나 Set 컬렉션을 이용해서 중복되는 값을 제거해야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select distinct t from Team t join fetch t.memberList\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Team</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllDistinctFetchJoin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@EntityGraph</span><span class=\"token punctuation\">(</span>attributePaths <span class=\"token operator\">=</span> <span class=\"token string\">\"memberList\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select distinct t from Team t\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Team</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllDistinctEntityGraph</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// Set을 이용하는 경우</span>\n\n<span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select t from Team t join fetch t.memberList\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Team</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllFetchJoinBySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n</li>\n<li>\n<p>페이징 처리가 어렵습니다. Fetch Join과 @EntityGraph에서는 페이징 API를 지원하지 않기 때문에 페이징 처리를 할 수 없습니다.</p>\n</li>\n</ol>\n<h2>BatchSize</h2>\n<p>BatchSize 값을 설정하면 한 번의 쿼리로 연관된 데이터 몇 개를 가져올 지를 지정할 수 있습니다. 예를 들어 70개의 가져올 데이터가 있고 BatchSize가 30인 경우, 총 3번의 쿼리로 30개, 30개, 10개씩 가져오게 됩니다. 하나의 쿼리로 모든 데이터를 조회할 수는 없지만(전체 데이터 수가 BatchSize보다 큰 경우), 기존의 N+1 문제에서 발생한 쿼리 수보다는 적게 발생합니다.</p>\n<h2>참고</h2>\n<ul>\n<li><a href=\"https://jojoldu.tistory.com/165\">[블로그] JPA N+1 문제 및 해결방안 (향로 님)</a></li>\n<li><a href=\"https://brunch.co.kr/@jinyoungchoi95/2\">[블로그] JPA N+1 발생 케이스와 해결책 (최진영 님)</a></li>\n<li><a href=\"https://www.inflearn.com/course/ORM-JPA-Basic\">[인프런 강의] 자바 ORM 표준 JPA 프로그래밍 - 기본편 (김영한 님)</a></li>\n</ul>","frontmatter":{"title":"[JPA] N+1 문제와 해결법","date":"September 30, 2023","tags":["Spring","JPA","N+1"],"series":null},"fields":{"slug":"/n+1-problem/"}},"seriesList":{"edges":[{"node":{"id":"6df80ce2-79eb-584d-871c-9ec94a17114c","fields":{"slug":"/n+1-problem/"},"frontmatter":{"title":"[JPA] N+1 문제와 해결법"}}},{"node":{"id":"bcaaf6e4-35eb-571f-9a88-4542117a9f40","fields":{"slug":"/http-vs-https/"},"frontmatter":{"title":"[Network] HTTP와 HTTPS"}}},{"node":{"id":"8894e599-37c7-5129-ab21-244e05db5ad2","fields":{"slug":"/boj-5549/"},"frontmatter":{"title":"[백준/BOJ] 5549. 행성 탐사 (파이썬)"}}},{"node":{"id":"a6cccf72-ac4a-5a0a-94d6-f0fd6a37c67c","fields":{"slug":"/boj-22862/"},"frontmatter":{"title":"[백준/BOJ] 22862. 가장 긴 짝수 연속한 부분 수열 (large) (파이썬)"}}},{"node":{"id":"b705571c-56ed-53b8-bc4a-28b8a6ac225b","fields":{"slug":"/boj-13144/"},"frontmatter":{"title":"[백준/BOJ] 13144. List of Unique Numbers (파이썬)"}}},{"node":{"id":"57c571b1-1719-5a80-8532-5a6140d2eefc","fields":{"slug":"/boj-3020/"},"frontmatter":{"title":"[백준/BOJ] 3020. 개똥벌레 (파이썬/자바)"}}},{"node":{"id":"25166810-bce0-59df-be14-b482f52201b9","fields":{"slug":"/programmers-67259/"},"frontmatter":{"title":"[프로그래머스] 67259. 경주로 건설 (파이썬)"}}},{"node":{"id":"cedea521-2919-5b27-8c40-5b7b7955957d","fields":{"slug":"/boj-2560/"},"frontmatter":{"title":"[백준/BOJ] 2560. 짚신벌레 (파이썬)"}}},{"node":{"id":"1948a1d0-9b32-57fd-9b38-efcb9fd17ea9","fields":{"slug":"/boj-1365/"},"frontmatter":{"title":"[백준/BOJ] 1365. 꼬인 전깃줄 (파이썬)"}}},{"node":{"id":"d4fa2a6f-24b5-5c1e-994d-83f00f4be67d","fields":{"slug":"/boj-11066/"},"frontmatter":{"title":"[백준/BOJ] 11066. 파일 합치기 (파이썬/자바)"}}},{"node":{"id":"ec4a3877-be55-5424-976d-62d6a6616693","fields":{"slug":"/boj-2293/"},"frontmatter":{"title":"[백준/BOJ] 2293. 동전 1 (파이썬)"}}},{"node":{"id":"0b952d2b-b9ac-5d71-8663-da4961afefa3","fields":{"slug":"/boj-2283/"},"frontmatter":{"title":"[백준/BOJ] 2283. 구간 자르기 (파이썬)"}}},{"node":{"id":"ca6873fb-a438-5c69-93c2-ad28fef74df1","fields":{"slug":"/aws-alb-502/"},"frontmatter":{"title":"AWS ALB가 502를 내뱉는다"}}}]},"previous":null,"next":{"fields":{"slug":"/whiletrue-01/"},"frontmatter":{"title":"whileTrue 프로젝트 후기"}}},"pageContext":{"id":"6df80ce2-79eb-584d-871c-9ec94a17114c","series":null,"previousPostId":null,"nextPostId":"28f0701a-8554-52af-bc32-a9a83e37ba31"}},"staticQueryHashes":[],"slicesMap":{}}